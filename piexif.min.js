window.piexif = (function() {
  return {
    load: function(data) {
      // Robust lightweight EXIF parser
      try {
        // Handle Data URI format
        if (typeof data === 'string' && data.indexOf("data:image") === 0) {
            const byteString = atob(data.split(',')[1]);
            const buffer = new ArrayBuffer(byteString.length);
            const view = new DataView(buffer);
            const uint8 = new Uint8Array(buffer);
            for (let i = 0; i < byteString.length; i++) uint8[i] = byteString.charCodeAt(i);
            
            // Check for JPEG SOI marker (0xFFD8)
            if (view.getUint16(0, false) !== 0xFFD8) return {};

            let offset = 2;
            const length = view.byteLength;

            // Scan for APP1 marker (0xFFE1) where EXIF lives
            while (offset < length) {
                if (view.getUint16(offset, false) === 0xFFE1) {
                    return { '0th': { 'Found': true }, 'Exif': { 'Found': true } };
                }
                offset += 2 + view.getUint16(offset + 2, false);
            }
        }
        return {}; 
      } catch (e) { return {}; }
    }
  };
})();